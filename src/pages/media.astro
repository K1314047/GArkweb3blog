---
import Base from '../layouts/Base.astro';
import SimpleHeader from '../components/SimpleHeader.astro';
import Tabs from '../components/Tabs.astro';
import TabItem from '../components/TabItem.astro';
import MediaCard from '../components/MediaCard.astro';
import neodbData from '../data/neodb.json';

const title = "书影音";
const description = "记录看过的书、电影和玩过的游戏";

    interface NeoDBItem {
        uuid?: string;
        item: {
            title: string;
            cover_image_url: string;
            brief: string;
            rating: number;
            url?: string;
        };
        comment_text: string;
        rating_grade: number;
        created_time: string;
        shelf_type?: string;
    }

// Helper to sort items by creation date (newest first)
const sortItems = (items: NeoDBItem[]) => {
    return items.sort((a, b) => new Date(b.created_time).getTime() - new Date(a.created_time).getTime());
};

const books = sortItems(((neodbData.book || []) as unknown) as NeoDBItem[]);
const movies = sortItems(((neodbData.movie || []) as unknown) as NeoDBItem[]);
const tvs = sortItems(((neodbData.tv || []) as unknown) as NeoDBItem[]); // Add TV shows
const games = sortItems(((neodbData.game || []) as unknown) as NeoDBItem[]);

const splitByStatus = (items: NeoDBItem[]) => {
    const watching = items.filter(item => item.shelf_type === 'progress');
    const completed = items.filter(item => item.shelf_type !== 'progress');
    return { watching, completed };
};

const bookGroups = splitByStatus(books);
const movieGroups = splitByStatus(movies);
const tvGroups = splitByStatus(tvs);
const gameGroups = splitByStatus(games);
---

<Base title={title} description={description} useCard={false} hideHeader={true} fullWidth={true}>
    <SimpleHeader title="Media" description={description} />

    <div class="content-limit-width media-page">
        <div class="media-tabs">
            <Tabs>
                <TabItem label="书籍" count={books.length}>
                    {books.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在看</h3>
                            </div>
                            {bookGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {bookGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在看记录。</p>}

                            <div class="media-group-header">
                                <h3 class="media-group-title">看过</h3>
                            </div>
                            {bookGroups.completed.length > 0 ? (
                                <div class="media-grid">
                                    {bookGroups.completed.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无看过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无书籍记录。</p>}
                </TabItem>

                <TabItem label="电影" count={movies.length}>
                    {movies.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在看</h3>
                            </div>
                            {movieGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {movieGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在看记录。</p>}

                            <div class="media-group-header">
                                <h3 class="media-group-title">看过</h3>
                            </div>
                            {movieGroups.completed.length > 0 ? (
                                <div class="media-grid">
                                    {movieGroups.completed.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无看过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无电影记录。</p>}
                </TabItem>

                <TabItem label="剧集" count={tvs.length}>
                    {tvs.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在看</h3>
                            </div>
                            {tvGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {tvGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在看记录。</p>}

                            <div class="media-group-header">
                                <h3 class="media-group-title">看过</h3>
                            </div>
                            {tvGroups.completed.length > 0 ? (
                                <div class="media-grid">
                                    {tvGroups.completed.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无看过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无剧集记录。</p>}
                </TabItem>

                <TabItem label="游戏" count={games.length}>
                    {games.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在玩</h3>
                            </div>
                            {gameGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {gameGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在玩记录。</p>}

                            <div class="media-group-header">
                                <h3 class="media-group-title">玩过</h3>
                            </div>
                            {gameGroups.completed.length > 0 ? (
                                <div class="media-grid">
                                    {gameGroups.completed.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无玩过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无游戏记录。</p>}
                </TabItem>
            </Tabs>
        </div>
    </div>
</Base>

<style>
    .media-page {
        padding: 0 0 2rem;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .media-group {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    .media-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 0 0.35rem 0;
        margin-top: 1.25rem;
        margin-bottom: 0.35rem;
    }

    .media-group-header:first-child {
        margin-top: 0;
    }

    .media-group-title {
        margin: 0;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--gray-color);
        letter-spacing: 0.03em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        padding-left: 0.75rem;
    }

    .media-group-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 1em;
        background: var(--heading-color);
        border-radius: 2px;
        opacity: 0.6;
    }

    .empty-state {
        margin: 0.35rem 0 0;
        color: var(--gray-color);
        font-size: 0.85rem;
        opacity: 0.7;
    }

    .content-limit-width {
        max-width: 1120px;
        margin: 0 auto;
        padding: 0 2rem;
        box-sizing: border-box;
        width: 100%;
    }

    :global(.media-tabs .tabs-header) {
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    :global(.media-tabs .tab-btn) {
        font-size: 1rem;
        padding: 0.7rem 0;
    }

    @media (max-width: 600px) {
        .media-grid {
            grid-template-columns: 1fr;
        }

        .content-limit-width {
            padding: 0 1.5rem;
        }
    }
</style>
